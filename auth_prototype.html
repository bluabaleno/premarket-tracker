<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-TGE Tracker</title>
    <style>
        :root {
            --bg: #0a0a0f;
            --bg-card: #141419;
            --bg-secondary: #1a1a1f;
            --text: #e4e4e7;
            --text-secondary: #71717a;
            --accent: #6366f1;
            --border: rgba(255,255,255,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 { font-size: 1.75rem; margin-bottom: 0.25rem; }
        header .subtitle { color: var(--text-secondary); font-size: 0.9rem; }

        /* Auth bar */
        .auth-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .auth-bar .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .auth-bar .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .login-btn, .logout-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn {
            background: #000;
            color: white;
            border: 1px solid #333;
        }
        .login-btn:hover { background: #1a1a1a; border-color: #555; }

        .login-btn svg { width: 16px; height: 16px; }

        .logout-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .logout-btn:hover { color: var(--text); border-color: var(--text-secondary); }

        /* Timeline */
        .timeline-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .timeline-header h2 { font-size: 1rem; }

        .month-axis {
            display: flex;
            padding-left: 140px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .month-axis .month {
            flex: 1;
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .month-axis .month.current { color: #22c55e; font-weight: 600; }

        /* Timeline rows */
        .timeline-row {
            display: flex;
            align-items: center;
            height: 36px;
            margin-bottom: 2px;
            padding: 0 8px;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .timeline-row:hover { background: rgba(255,255,255,0.03); }

        .timeline-row .project-name {
            width: 130px;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: right;
            padding-right: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timeline-row .bar-container {
            flex: 1;
            position: relative;
            height: 100%;
        }

        .timeline-row .bar {
            position: absolute;
            height: 20px;
            top: 8px;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        .timeline-row .bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.12), transparent);
            border-radius: 5px 5px 0 0;
        }

        .timeline-row .marker {
            position: absolute;
            width: 3px;
            height: 24px;
            top: 6px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 6px rgba(255,255,255,0.5);
        }

        /* Locked/blurred rows */
        .timeline-row.locked .bar-container {
            filter: blur(8px);
            opacity: 0.5;
        }

        .timeline-row.locked .lock-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: rgba(99,102,241,0.2);
            border-radius: 6px;
            margin-left: 8px;
        }

        .timeline-row.locked .lock-icon svg {
            width: 12px;
            height: 12px;
            color: var(--accent);
        }

        .timeline-row:not(.locked) .lock-icon { display: none; }

        /* Unlock prompt */
        .unlock-prompt {
            display: none;
            text-align: center;
            padding: 20px;
            margin-top: 16px;
            background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(99,102,241,0.05) 100%);
            border: 1px solid rgba(99,102,241,0.2);
            border-radius: 10px;
        }

        .unlock-prompt.show { display: block; }

        .unlock-prompt p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .unlock-prompt strong { color: var(--text); }

        /* Login error */
        .login-error {
            display: none;
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: #ef4444;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
            text-align: center;
        }

        .login-error.show { display: block; }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,10,15,0.9);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-overlay.show { display: flex; }

        .loading-overlay span { color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <span>Verifying access...</span>
    </div>

    <div class="container">
        <header>
            <h1>üöÄ Pre-TGE Tracker</h1>
            <p class="subtitle">Token launch predictions from Polymarket & Limitless</p>
        </header>

        <!-- Auth Bar -->
        <div class="auth-bar">
            <div id="auth-status">
                <!-- Logged out state -->
                <div id="logged-out">
                    <button class="login-btn" onclick="initiateLogin()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        Sign in for full access
                    </button>
                </div>
                <!-- Logged in state -->
                <div id="logged-in" style="display:none;">
                    <div class="user-info">
                        <div class="avatar" id="user-avatar">?</div>
                        <span id="user-handle">@username</span>
                    </div>
                </div>
            </div>
            <button class="logout-btn" id="logout-btn" style="display:none;" onclick="logout()">Log out</button>
        </div>

        <div id="login-error" class="login-error">
            You're not on the whitelist. Contact the admin for access.
        </div>

        <!-- Timeline -->
        <div class="timeline-container">
            <div class="timeline-header">
                <h2>üóìÔ∏è Launch Timeline</h2>
                <span style="font-size:0.75rem;color:var(--text-secondary);" id="visible-count"></span>
            </div>

            <div class="month-axis" id="month-axis"></div>
            <div id="timeline-rows"></div>

            <div class="unlock-prompt" id="unlock-prompt">
                <p><strong id="hidden-count">0</strong> more projects launching March onwards</p>
                <button class="login-btn" onclick="initiateLogin()">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    Sign in with X to unlock
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        const X_CLIENT_ID = 'cW1KOHN4Uy1sVXBwYk1qUk9mUHo6MTpjaQ';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const API_ENDPOINT = 'https://premarket-tracker-kzx8wc64v-jacques-limitlessnes-projects.vercel.app/api/x-auth';

        const WHITELIST = [
            'jacqueswhales',
        ];

        // Cutoff: projects launching after this month are blurred
        const CUTOFF_MONTH = 2; // 1=Jan, 2=Feb, 3=Mar... (show Jan+Feb, blur March+)

        // Sample timeline data (in production, this comes from dashboard generation)
        const TIMELINE_DATA = [
            { name: 'MegaETH', launchMonth: 1, prob: 0.85, color: '16,185,129' },
            { name: 'Berachain', launchMonth: 1, prob: 0.92, color: '245,158,11' },
            { name: 'Monad', launchMonth: 2, prob: 0.65, color: '99,102,241' },
            { name: 'Story Protocol', launchMonth: 2, prob: 0.55, color: '16,185,129' },
            { name: 'Initia', launchMonth: 3, prob: 0.45, color: '99,102,241' },
            { name: 'Fuel', launchMonth: 3, prob: 0.40, color: '245,158,11' },
            { name: 'Eclipse', launchMonth: 4, prob: 0.35, color: '99,102,241' },
            { name: 'Espresso', launchMonth: 4, prob: 0.30, color: '139,92,246' },
            { name: 'Caldera', launchMonth: 5, prob: 0.25, color: '99,102,241' },
            { name: 'Conduit', launchMonth: 6, prob: 0.20, color: '99,102,241' },
        ];

        // ============================================
        // AUTH STATE
        // ============================================

        let isAuthenticated = false;
        let currentUser = null;

        window.onload = function() {
            // Check for OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                handleOAuthCallback(code);
                return;
            }

            // Check for existing session
            const savedUser = localStorage.getItem('x_auth_user');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                if (isWhitelisted(user.username)) {
                    loginSuccess(user);
                } else {
                    localStorage.removeItem('x_auth_user');
                }
            }

            renderTimeline();
        };

        // ============================================
        // OAUTH FLOW
        // ============================================

        async function initiateLogin() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            sessionStorage.setItem('code_verifier', codeVerifier);

            const authUrl = new URL('https://twitter.com/i/oauth2/authorize');
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('client_id', X_CLIENT_ID);
            authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.set('scope', 'tweet.read users.read');
            authUrl.searchParams.set('state', generateState());
            authUrl.searchParams.set('code_challenge', codeChallenge);
            authUrl.searchParams.set('code_challenge_method', 'S256');

            window.location.href = authUrl.toString();
        }

        async function handleOAuthCallback(code) {
            showLoading(true);
            window.history.replaceState({}, document.title, window.location.pathname);

            const codeVerifier = sessionStorage.getItem('code_verifier');

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        code_verifier: codeVerifier,
                        redirect_uri: REDIRECT_URI
                    })
                });

                const userInfo = await response.json();

                if (!response.ok) {
                    throw new Error(userInfo.error || 'Auth failed');
                }

                logLogin(userInfo);

                if (isWhitelisted(userInfo.username)) {
                    localStorage.setItem('x_auth_user', JSON.stringify(userInfo));
                    loginSuccess(userInfo);
                } else {
                    showLoginError();
                }
            } catch (error) {
                console.error('Auth error:', error);
                showLoginError();
            }

            showLoading(false);
            renderTimeline();
        }

        function loginSuccess(user) {
            isAuthenticated = true;
            currentUser = user;

            document.getElementById('logged-out').style.display = 'none';
            document.getElementById('logged-in').style.display = 'flex';
            document.getElementById('logout-btn').style.display = 'block';
            document.getElementById('user-handle').textContent = '@' + user.username;
            document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();
            document.getElementById('login-error').classList.remove('show');

            renderTimeline();
        }

        function logout() {
            localStorage.removeItem('x_auth_user');
            isAuthenticated = false;
            currentUser = null;

            document.getElementById('logged-out').style.display = 'block';
            document.getElementById('logged-in').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';

            renderTimeline();
        }

        // ============================================
        // TIMELINE RENDERING
        // ============================================

        function renderTimeline() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonth = new Date().getMonth(); // 0-indexed

            // Render month axis
            const axisHtml = months.map((m, i) =>
                `<div class="month${i === currentMonth ? ' current' : ''}">${m}</div>`
            ).join('');
            document.getElementById('month-axis').innerHTML = axisHtml;

            // Render timeline rows
            let rowsHtml = '';
            let visibleCount = 0;
            let hiddenCount = 0;

            TIMELINE_DATA.forEach(project => {
                const isLocked = !isAuthenticated && project.launchMonth > CUTOFF_MONTH;

                if (isLocked) {
                    hiddenCount++;
                } else {
                    visibleCount++;
                }

                // Calculate bar position (simplified)
                const startPct = ((project.launchMonth - 1) / 12) * 100;
                const widthPct = (2 / 12) * 100; // 2 month span
                const markerPct = ((project.launchMonth - 0.5) / 12) * 100;
                const alpha = 0.3 + project.prob * 0.6;

                rowsHtml += `
                    <div class="timeline-row ${isLocked ? 'locked' : ''}">
                        <div class="project-name">${project.name}</div>
                        <div class="bar-container">
                            <div class="bar" style="left:${startPct}%;width:${widthPct}%;background:rgba(${project.color},${alpha});"></div>
                            <div class="marker" style="left:${markerPct}%;"></div>
                        </div>
                        <div class="lock-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                    </div>
                `;
            });

            document.getElementById('timeline-rows').innerHTML = rowsHtml;
            document.getElementById('visible-count').textContent = `${visibleCount} projects visible`;

            // Show/hide unlock prompt
            if (hiddenCount > 0 && !isAuthenticated) {
                document.getElementById('hidden-count').textContent = hiddenCount;
                document.getElementById('unlock-prompt').classList.add('show');
            } else {
                document.getElementById('unlock-prompt').classList.remove('show');
            }
        }

        // ============================================
        // HELPERS
        // ============================================

        function isWhitelisted(username) {
            return WHITELIST.includes(username.toLowerCase());
        }

        function logLogin(user) {
            console.log('Login attempt:', { username: user.username, timestamp: new Date().toISOString() });
            const logins = JSON.parse(localStorage.getItem('login_history') || '[]');
            logins.push({ username: user.username, timestamp: new Date().toISOString() });
            localStorage.setItem('login_history', JSON.stringify(logins));
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function showLoginError() {
            document.getElementById('login-error').classList.add('show');
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64UrlEncode(array);
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64UrlEncode(new Uint8Array(hash));
        }

        function generateState() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return base64UrlEncode(array);
        }

        function base64UrlEncode(array) {
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // ============================================
        // DEV HELPERS
        // ============================================
        console.log('%cüîê Auth Prototype v2', 'font-size: 14px; font-weight: bold;');
        console.log('Test commands:');
        console.log('  testLogin("jacqueswhales") - login as whitelisted user');
        console.log('  testLogin("random")        - test non-whitelisted');
        console.log('  logout()                   - log out');

        function testLogin(username) {
            const user = { id: 'test', username: username.toLowerCase().replace('@', ''), name: username };
            if (isWhitelisted(user.username)) {
                localStorage.setItem('x_auth_user', JSON.stringify(user));
                logLogin(user);
                loginSuccess(user);
            } else {
                logLogin(user);
                showLoginError();
            }
        }
    </script>
</body>
</html>
